---
import Layout from "../../layouts/Layout.astro";
import { getCollection } from "astro:content";

const archives = (await getCollection("archive")).sort((a, b) => {
    // Pinned items first
    if (a.data.pinned && !b.data.pinned) return -1;
    if (!a.data.pinned && b.data.pinned) return 1;
    // Then by date
    return b.data.pubDate.valueOf() - a.data.pubDate.valueOf();
});

// Collect all unique tags
const allTags = [...new Set(archives.flatMap(item => item.data.tags || []))];
---

<Layout title="제이원텍(주) | 자료실" description="제이원텍(주) 자료실">
    <div class="container mx-auto px-4 py-16 max-w-4xl">
        <!-- Hero Section -->
        <div class="text-center mb-12">
            <div class="inline-block px-4 py-1 bg-primary/10 text-primary rounded-full text-sm font-medium mb-4">
                ARCHIVE
            </div>
            <h1 class="text-4xl md:text-5xl font-bold mb-4">자료실</h1>
            <p class="text-base-content/60">
                제품 관련 자료를 다운로드하세요
            </p>
        </div>
        
        <!-- Tag Filter & Search -->
        <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4 mb-6">
            <!-- Tag Filter Dropdown -->
            {allTags.length > 0 && (
                <select id="tagFilter" class="select select-bordered select-sm w-full sm:w-auto">
                    <option value="all">전체 태그</option>
                    {allTags.map(tag => (
                        <option value={tag}>{tag}</option>
                    ))}
                </select>
            )}

            <!-- Search Bar -->
            <label class="input input-bordered input-sm flex items-center gap-2 w-full sm:w-auto sm:max-w-xs bg-base-100 shadow-sm">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16" fill="currentColor" class="w-4 h-4 opacity-50"><path fill-rule="evenodd" d="M9.965 11.026a5 5 0 1 1 1.06-1.06l2.755 2.754a.75.75 0 1 1-1.06 1.06l-2.755-2.754ZM10.5 7a3.5 3.5 0 1 1-7 0 3.5 3.5 0 0 1 7 0Z" clip-rule="evenodd" /></svg>
                <input type="text" id="searchInput" class="grow" placeholder="검색" />
            </label>
        </div>

        <!-- Archive List -->
        <div class="bg-base-100 rounded-md border border-base-200 shadow-sm overflow-hidden" id="archiveList">
            {archives.length === 0 ? (
                <div class="text-center py-16">
                    <div class="w-16 h-16 mx-auto mb-4 rounded-full bg-base-200 flex items-center justify-center">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-base-content/30" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 8h14M5 8a2 2 0 110-4h14a2 2 0 110 4M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8m-9 4h4" />
                        </svg>
                    </div>
                    <p class="text-base-content/50">등록된 자료가 없습니다.</p>
                </div>
            ) : (
                archives.map((item, index) => (
                    <div 
                        class="group archive-item flex items-center gap-4 px-5 py-4 hover:bg-base-50 transition-colors border-b border-base-200 last:border-b-0"
                        data-tags={JSON.stringify(item.data.tags || [])}
                    >
                        <!-- Pin Icon or Number -->
                        <span class="flex-shrink-0 w-8 text-center self-start pt-0.5">
                            {item.data.pinned ? (
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-primary mx-auto" fill="currentColor" viewBox="0 0 24 24">
                                    <path d="M16 4a1 1 0 0 1 1 1v3.586l1.707 1.707a1 1 0 0 1 .293.707v2a1 1 0 0 1-1 1h-4v6a1 1 0 1 1-2 0v-6H8a1 1 0 0 1-1-1v-2a1 1 0 0 1 .293-.707L9 8.586V5a1 1 0 0 1 1-1h6z"/>
                                </svg>
                            ) : (
                                <span class="text-sm font-medium text-base-content/40">{archives.length - index}</span>
                            )}
                        </span>
                        
                        <!-- Content -->
                        <div class="flex-1 min-w-0">
                            <div class="flex items-center gap-2 flex-wrap mb-1">
                                <a href={`/archive/${item.slug}`} class="font-medium text-sm hover:text-primary transition-colors truncate block archive-title">
                                    {item.data.title}
                                </a>
                                {item.data.tags && item.data.tags.map(tag => (
                                    <span class="badge badge-xs badge-outline badge-primary">{tag}</span>
                                ))}
                            </div>
                            <span class="text-xs text-base-content/50 line-clamp-1 block">
                                {item.data.description}
                            </span>
                        </div>
                        
                        <!-- Date -->
                        <span class="flex-shrink-0 text-xs text-base-content/40 hidden sm:block">
                            {item.data.pubDate.toLocaleDateString('ko-KR')}
                        </span>
                        
                        <!-- Download Button -->
                        {item.data.fileUrl && (
                            <a 
                                href={item.data.fileUrl} 
                                class="btn btn-primary btn-sm gap-1 flex-shrink-0"
                                target="_blank"
                                rel="noopener noreferrer"
                            >
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" />
                                </svg>
                                다운로드
                            </a>
                        )}
                    </div>
                ))
            )}
        </div>

        <script>
            const searchInput = document.getElementById('searchInput') as HTMLInputElement;
            const archiveList = document.getElementById('archiveList');
            const tagFilter = document.getElementById('tagFilter');
            let currentTag = 'all';
            
            function filterArchives() {
                if (!archiveList) return;
                const items = archiveList.getElementsByClassName('archive-item');
                const searchFilter = searchInput?.value.toLowerCase() || '';

                for (let i = 0; i < items.length; i++) {
                    const item = items[i] as HTMLElement;
                    const titleElement = item.getElementsByClassName('archive-title')[0] as HTMLElement;
                    const tags = JSON.parse(item.dataset.tags || '[]');
                    
                    const matchesSearch = !searchFilter || 
                        (titleElement?.textContent || '').toLowerCase().indexOf(searchFilter) > -1;
                    const matchesTag = currentTag === 'all' || tags.includes(currentTag);
                    
                    item.style.display = matchesSearch && matchesTag ? '' : 'none';
                }
            }
            
            if (searchInput) {
                searchInput.addEventListener('keyup', filterArchives);
            }
            
            if (tagFilter) {
                tagFilter.addEventListener('change', () => {
                    currentTag = (tagFilter as HTMLSelectElement).value;
                    filterArchives();
                });
            }
        </script>
    </div>
</Layout>
